#pragma once

#include "utils.h"

class EpilogueWarpIterator {
public:
  CUTLASS_HOST_DEVICE
  EpilogueWarpIterator(float* data):
    pointer_((Array<float, 4> *)data) {
    int row_major = (threadIdx.x % 32) / 16;
    int residual = (threadIdx.x % 32) % 16;
    int column = residual / 2;
    int row_minor =  residual % 2;
    pointer_ += row_major * 64 + row_minor * 32 + column;

    int warp_id = threadIdx.x / 32;
    pointer_ += (warp_id % 4) * 128 + (warp_id / 4) * 16;
  }

  CUTLASS_HOST_DEVICE
  void store(Array<float, 8> const &frag) {
    Array<float, 4> const *scalarFragPtr = reinterpret_cast<Array<float, 4> const *>(&frag);
    pointer_[0] = scalarFragPtr[0];
    pointer_[8] = scalarFragPtr[1];
  }
private:
  Array<float, 4> *pointer_;
};

//   0    2    4    6    8   10   12   14 |   0    2    4    6    8   10   12   14  | 128  130  132  134  136  138  140  142  | 128  130  132  134  136  138  140  142
//   1    3    5    7    9   11   13   15 |   1    3    5    7    9   11   13   15  | 129  131  133  135  137  139  141  143  | 129  131  133  135  137  139  141  143
//  16   18   20   22   24   26   28   30 |  16   18   20   22   24   26   28   30  | 144  146  148  150  152  154  156  158  | 144  146  148  150  152  154  156  158
//  17   19   21   23   25   27   29   31 |  17   19   21   23   25   27   29   31  | 145  147  149  151  153  155  157  159  | 145  147  149  151  153  155  157  159

//  32   34   36   38   40   42   44   46 |  32   34   36   38   40   42   44   46  | 160  162  164  166  168  170  172  174  | 160  162  164  166  168  170  172  174
//  33   35   37   39   41   43   45   47 |  33   35   37   39   41   43   45   47  | 161  163  165  167  169  171  173  175  | 161  163  165  167  169  171  173  175
//  48   50   52   54   56   58   60   62 |  48   50   52   54   56   58   60   62  | 176  178  180  182  184  186  188  190  | 176  178  180  182  184  186  188  190
//  49   51   53   55   57   59   61   63 |  49   51   53   55   57   59   61   63  | 177  179  181  183  185  187  189  191  | 177  179  181  183  185  187  189  191

//  64   66   68   70   72   74   76   78 |  64   66   68   70   72   74   76   78  | 192  194  196  198  200  202  204  206  | 192  194  196  198  200  202  204  206
//  65   67   69   71   73   75   77   79 |  65   67   69   71   73   75   77   79  | 193  195  197  199  201  203  205  207  | 193  195  197  199  201  203  205  207
//  80   82   84   86   88   90   92   94 |  80   82   84   86   88   90   92   94  | 208  210  212  214  216  218  220  222  | 208  210  212  214  216  218  220  222
//  81   83   85   87   89   91   93   95 |  81   83   85   87   89   91   93   95  | 209  211  213  215  217  219  221  223  | 209  211  213  215  217  219  221  223

//  96   98  100  102  104  106  108  110 |  96   98  100  102  104  106  108  110  | 224  226  228  230  232  234  236  238  | 224  226  228  230  232  234  236  238
//  97   99  101  103  105  107  109  111 |  97   99  101  103  105  107  109  111  | 225  227  229  231  233  235  237  239  | 225  227  229  231  233  235  237  239
// 112  114  116  118  120  122  124  126 | 112  114  116  118  120  122  124  126  | 240  242  244  246  248  250  252  254  | 240  242  244  246  248  250  252  254
// 113  115  117  119  121  123  125  127 | 113  115  117  119  121  123  125  127  | 241  243  245  247  249  251  253  255  | 241  243  245  247  249  251  253  255
